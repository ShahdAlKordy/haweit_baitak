<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูููุฉ ุจูุชู - ุฅุฏุงุฑุฉ ุงูุทูุจุงุช</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .sidebar { background: #142952; }
        .active-tab { background: rgba(255, 255, 255, 0.1); border-right: 4px solid #fbbf24; }
        
        /* A4 Professional Invoice Styling */
        .invoice-a4 {
            width: 210mm;
            height: 296mm;
            max-height: 296mm;
            background: white;
            margin: 0 auto;
            padding: 8mm 12mm;
            box-sizing: border-box;
            color: #000;
            line-height: 1.3;
            position: relative;
            overflow: hidden;
        }

        .inv-header-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; border-bottom: 2px solid #142952; padding-bottom: 10px; margin-bottom: 15px; }
        .inv-info-box { background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #f1f5f9; }
        .inv-table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        .inv-table th { background: #142952; color: white; padding: 6px 8px; text-align: right; font-size: 12px; border: 1px solid #142952; }
        .inv-table td { border: 1px solid #e2e8f0; padding: 6px 8px; vertical-align: top; font-size: 11px; }
        .inv-total-row { background: #142952; color: white; font-weight: 900; }
        
        @media print {
            @page { size: A4; margin: 0; }
            .no-print { display: none !important; }
            body { background: white; margin: 0; padding: 0; }
            .invoice-a4 { 
                width: 210mm; 
                height: 297mm; 
                margin: 0; 
                padding: 8mm 12mm; 
                border: none; 
                page-break-after: always; 
                position: relative; 
                overflow: hidden; 
            }
            #capture-area { position: relative !important; left: 0 !important; top: 0 !important; width: 100% !important; }
        }

        #capture-area { position: absolute; left: -9999px; top: 0; width: 210mm; }
        .loader-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex">
        
        <aside class="sidebar w-64 text-white flex flex-col no-print fixed h-full z-50 shadow-2xl">
            <div class="p-8 text-center border-b border-white/5">
                <div class="w-24 h-24 bg-white rounded-3xl mx-auto mb-4 flex items-center justify-center p-2 shadow-xl overflow-hidden">
                    <img src="logo1.png" alt="Logo" class="w-full h-full object-contain" onerror="this.src='https://i.ibb.co/68vD84D/logo1.png'">
                </div>
                <h1 class="text-xl font-black">ูููุฉ ุจูุชู</h1>
                <p class="text-blue-300 text-[10px] mt-1 tracking-widest font-bold uppercase">ูุธุงู ุฅุฏุงุฑุฉ ุงููุจูุนุงุช</p>
            </div>
            
            <nav class="flex-1 py-10 px-4 space-y-2">
                <button @click="setTab('create')" :class="{'active-tab': activeTab === 'create'}" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl transition-all font-bold hover:bg-white/5">
                    <i data-lucide="plus-circle" class="w-5 h-5 text-yellow-400"></i> ุชุณุฌูู ุทูุจ
                </button>
                <button @click="setTab('archive')" :class="{'active-tab': activeTab === 'archive'}" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl transition-all font-bold hover:bg-white/5">
                    <i data-lucide="database" class="w-5 h-5 text-yellow-400"></i> ุฃุฑุดูู ุงูุทูุจุงุช
                </button>
                <button @click="setTab('invoices')" :class="{'active-tab': activeTab === 'invoices'}" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl transition-all font-bold hover:bg-white/5">
                    <i data-lucide="printer" class="w-5 h-5 text-yellow-400"></i> ูุฑูุฒ ุงูููุงุชูุฑ
                </button>
                <button @click="setTab('catalog')" :class="{'active-tab': activeTab === 'catalog'}" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl transition-all font-bold hover:bg-white/5">
                    <i data-lucide="package" class="w-5 h-5 text-yellow-400"></i> ุงูููุชุฌุงุช
                </button>
            </nav>
        </aside>

        <main class="flex-1 mr-64 p-8 no-print relative min-h-screen">
            
            <div v-if="notification" class="fixed top-10 left-10 z-[100] p-5 rounded-2xl shadow-2xl bg-white border-l-8 flex items-center gap-4 animate-bounce" :class="notification.type === 'error' ? 'border-red-500 text-red-600' : 'border-green-500 text-green-600'">
                <i v-if="notification.type === 'success'" data-lucide="check-circle"></i>
                <i v-else data-lucide="alert-circle"></i>
                <span class="font-black">{{ notification.msg }}</span>
            </div>

            <div v-if="loading" class="fixed inset-0 bg-white/70 z-40 flex flex-col items-center justify-center backdrop-blur-sm">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-[#142952] mb-4"></div>
                <p class="font-black text-[#142952]">ุฌุงุฑู ูุฒุงููุฉ ุงูุจูุงูุงุช...</p>
            </div>

            <header class="mb-10 flex justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div>
                    <h2 class="text-3xl font-black text-[#142952]">
                        <span v-if="activeTab === 'create'">{{ editingOrder ? 'ุชุนุฏูู ุจูุงูุงุช ุงูุทูุจ' : 'ุชุณุฌูู ุทูุจ ุฌุฏูุฏ' }}</span>
                        <span v-if="activeTab === 'archive'">ุงูุฃุฑุดูู ูุงููุฒุงููุฉ</span>
                        <span v-if="activeTab === 'invoices'">ุฅุตุฏุงุฑ ูุชุญููู ุงูููุงุชูุฑ</span>
                        <span v-if="activeTab === 'catalog'">ุฅุฏุงุฑุฉ ุงูููุชุฌุงุช</span>
                    </h2>
                </div>
                <div class="flex gap-2">
                    <button @click="syncFromSheet" class="bg-[#142952] text-white px-6 py-3 rounded-2xl font-black flex items-center gap-2 shadow-lg hover:bg-blue-800 transition-all">
                        <i data-lucide="refresh-cw" :class="{'loader-spin': syncLoading}" class="w-4 h-4"></i>
                        ูุฒุงููุฉ ุงูุณุญุงุจ
                    </button>
                </div>
            </header>

            <section v-if="activeTab === 'create'" class="bg-white p-8 rounded-3xl shadow-sm border animate-in">
                <form @submit.prevent="saveOrder" class="space-y-8">
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 bg-blue-50/50 p-8 rounded-3xl mb-4 border border-blue-100">
                        <div class="col-span-full font-black text-[#142952] flex items-center gap-2 mb-2 text-lg">
                            <i data-lucide="settings"></i> ุฅุนุฏุงุฏุงุช ุงูุทูุจ
                        </div>
                        <div class="space-y-1 lg:col-span-2">
                            <label class="text-[11px] font-black text-gray-400 mr-2 uppercase">ุฑูุฒ ุงููุณุคูู (ุญุฑููู)</label>
                            <input v-model="orderForm.managerCode" maxlength="2" required class="w-full p-3.5 border-2 border-transparent bg-white rounded-2xl shadow-sm focus:border-blue-500 outline-none font-bold uppercase tracking-widest text-center" placeholder="ูุซุงู: AB">
                        </div>
                        <div class="space-y-1 lg:col-span-2">
                            <label class="text-[11px] font-black text-gray-400 mr-2 uppercase">ูุณุจุฉ ุงูุฎุตู (%) - ุฅู ูุฌุฏ</label>
                            <input v-model.number="orderForm.discountRate" type="number" min="0" max="100" class="w-full p-3.5 border-2 border-transparent bg-white rounded-2xl shadow-sm focus:border-blue-500 outline-none font-bold text-center text-red-500" placeholder="0">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 bg-gray-50 p-8 rounded-3xl">
                        <div class="col-span-full font-black text-[#142952] flex items-center gap-2 mb-2 text-lg">
                            <i data-lucide="user"></i> ุจูุงูุงุช ุงูุนููู ุงูุฃุณุงุณูุฉ
                        </div>
                        <div class="space-y-1">
                            <label class="text-[11px] font-black text-gray-400 mr-2 uppercase">ุงุณู ุงูุนููู</label>
                            <input v-model="orderForm.client.name" required class="w-full p-3.5 border-2 border-transparent bg-white rounded-2xl shadow-sm focus:border-blue-500 outline-none font-bold">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[11px] font-black text-gray-400 mr-2 uppercase">ุงููุฏููุฉ</label>
                            <input v-model="orderForm.client.city" required class="w-full p-3.5 border-2 border-transparent bg-white rounded-2xl shadow-sm focus:border-blue-500 outline-none font-bold">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[11px] font-black text-gray-400 mr-2 uppercase">ุงูุฌูุงู</label>
                            <input v-model="orderForm.client.phone" required class="w-full p-3.5 border-2 border-transparent bg-white rounded-2xl shadow-sm focus:border-blue-500 outline-none font-bold" dir="ltr">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[11px] font-black text-gray-400 mr-2 uppercase">ุงูุนููุงู ุจุงูุชูุตูู</label>
                            <input v-model="orderForm.client.address" required class="w-full p-3.5 border-2 border-transparent bg-white rounded-2xl shadow-sm focus:border-blue-500 outline-none font-bold">
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="flex justify-between items-center border-b pb-4">
                            <h3 class="text-xl font-black text-[#142952]">ูุงุฆูุฉ ุงูููุชุฌุงุช ุงููุทููุจุฉ</h3>
                            <button type="button" @click="addProductRow" class="bg-blue-50 text-blue-600 px-6 py-2 rounded-xl font-black text-sm transition-all hover:bg-blue-100">+ ุฅุถุงูุฉ ููุชุฌ</button>
                        </div>
                        <div v-for="(p, index) in orderForm.products" :key="p.id" class="p-8 border-2 border-gray-50 rounded-3xl relative bg-white hover:border-blue-100 transition-all shadow-sm">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div class="space-y-1">
                                    <label class="text-[10px] font-black text-gray-400 uppercase">ุงุฎุชุฑ ุงูููุชุฌ</label>
                                    <select v-model="p.productId" @change="syncProductData(p)" required class="w-full p-3 border rounded-xl bg-gray-50 font-bold text-sm">
                                        <option value="">ุงุฎุชุฑ ูู ุงููุงุฆูุฉ...</option>
                                        <option v-for="item in catalog" :value="item.id">{{ item.name }} (SAR {{ item.price }})</option>
                                    </select>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-black text-gray-400 uppercase">ุงูููู</label>
                                    <select v-model="p.color" @change="updatePrice(p)" class="w-full p-3 border rounded-xl bg-gray-50 font-bold text-sm">
                                        <option value="silver">ุณูููุฑ (ูุถู)</option>
                                        <option value="gold">ุฌููุฏ (ุฐูุจู) +19 SAR</option>
                                    </select>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-black text-gray-400 uppercase">ุงููููุฉ</label>
                                    <input v-model.number="p.count" type="number" min="1" class="w-full p-3 border rounded-xl bg-gray-50 font-bold text-sm text-center">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-black text-blue-600 uppercase">ุงูุนููุงู ุงููุทูู</label>
                                    <input v-model="p.nationalAddress" class="w-full p-3 border-2 border-blue-50 rounded-xl bg-blue-50/30 font-bold text-sm">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-black text-gray-400 uppercase">ุฑูู ุงููููุง</label>
                                    <input v-model="p.villaNo" class="w-full p-3 border rounded-xl bg-gray-50 font-bold text-sm">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-[10px] font-black text-gray-400 uppercase">ุงูุงุณู ุงููุทููุจ</label>
                                    <input v-model="p.customName" class="w-full p-3 border rounded-xl bg-gray-50 font-bold text-sm">
                                </div>
                                <div class="lg:col-span-2 space-y-1">
                                    <label class="text-[10px] font-black text-gray-400 uppercase">ููุงุญุธุงุช ุฅุถุงููุฉ</label>
                                    <input v-model="p.notes" class="w-full p-3 border rounded-xl bg-gray-50 font-bold text-sm">
                                </div>
                            </div>
                            <button v-if="orderForm.products.length > 1" @click="removeProductRow(index)" type="button" class="absolute -top-3 -left-3 bg-red-500 text-white p-2.5 rounded-full shadow-lg transition-transform hover:scale-110">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center border-t pt-10">
                        <div class="flex flex-col">
                            <div v-if="orderForm.discountRate > 0" class="font-bold text-gray-400 text-sm line-through decoration-red-400">{{ calculateSubTotal() }} SAR</div>
                            <div class="font-black text-4xl text-green-600">{{ calculateTotal() }} SAR</div>
                            <div v-if="orderForm.discountRate > 0" class="font-bold text-red-500 text-xs mt-1">ุชู ุชุทุจูู ุฎุตู {{ orderForm.discountRate }}%</div>
                        </div>
                        <div class="flex gap-4">
                            <button v-if="editingOrder" type="button" @click="cancelEdit" class="bg-gray-200 px-10 py-4 rounded-2xl font-black text-gray-600 shadow-sm transition-all hover:bg-gray-300">ุฅูุบุงุก</button>
                            <button type="submit" :disabled="isSaving" class="bg-[#142952] text-white px-16 py-4 rounded-2xl font-black shadow-xl hover:scale-105 active:scale-95 transition-all">
                                {{ isSaving ? 'ุฌุงุฑู ุงููุฒุงููุฉ...' : (editingOrder ? 'ุชุญุฏูุซ ุงูุทูุจ' : 'ุญูุธ ุงูุทูุจ') }}
                            </button>
                        </div>
                    </div>
                </form>
            </section>

            <section v-if="activeTab === 'archive'" class="bg-white rounded-3xl shadow-sm border overflow-hidden animate-in">
                <div class="p-8 bg-gray-50 flex justify-between items-center border-b">
                    <div class="relative w-96">
                        <i data-lucide="search" class="absolute right-4 top-3.5 text-gray-400 w-5 h-5"></i>
                        <input v-model="searchQuery" class="w-full pr-12 pl-6 py-3.5 bg-white border-none rounded-2xl shadow-sm focus:ring-2 focus:ring-blue-500 outline-none font-bold" placeholder="ุงุจุญุซ ุจุงุณู ุงูุนููู ุฃู ุฑูู ุงูุทูุจ...">
                    </div>
                    <div class="font-black text-gray-400">ุงูุฅุฌูุงูู: {{ filteredOrders.length }} ุทูุจ</div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right border-collapse text-sm">
                        <thead class="bg-[#142952] text-white">
                            <tr>
                                <th class="p-6">ุฑูู ุงูุทูุจ</th>
                                <th class="p-6">ุงูุชุงุฑูุฎ</th>
                                <th class="p-6">ุงูุนููู</th>
                                <th class="p-6">ุงูุนููุงู</th>
                                <th class="p-6">ุงููุจูุบ</th>
                                <th class="p-6 text-center">ุฅุฌุฑุงุกุงุช</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="order in filteredOrders" :key="order.id" class="border-b hover:bg-blue-50/50 transition-all">
                                <td class="p-6 font-mono font-black text-blue-700 uppercase">{{ order.orderId }}</td>
                                <td class="p-6 text-xs text-gray-500 font-bold">{{ formatDate(order.timestamp) }}</td>
                                <td class="p-6 font-black text-gray-800">{{ order.client.name }}</td>
                                <td class="p-4 max-w-xs truncate font-bold text-gray-400">{{ order.client.address }}</td>
                                <td class="p-6 font-black text-green-600">{{ order.totalAmount }} SAR</td>
                                <td class="p-6">
                                    <div class="flex justify-center gap-2">
                                        <button @click="viewInvoice(order)" class="p-3 bg-blue-50 text-blue-600 rounded-xl hover:bg-blue-600 hover:text-white transition-all"><i data-lucide="eye" class="w-4 h-4"></i></button>
                                        <button @click="editOrder(order)" class="p-3 bg-yellow-50 text-yellow-600 rounded-xl hover:bg-yellow-600 hover:text-white transition-all"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                        <button @click="deleteOrder(order)" class="p-3 bg-red-50 text-red-500 rounded-xl hover:bg-red-600 hover:text-white transition-all"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <section v-if="activeTab === 'invoices'" class="space-y-8 animate-in">
                <div class="bg-white p-8 rounded-3xl shadow-sm border flex flex-col md:flex-row justify-between items-center gap-6">
                    <div class="flex items-center gap-6">
                        <label class="font-black text-[#142952] text-lg">ุชุงุฑูุฎ ุงูููุงุชูุฑ:</label>
                        <input type="date" v-model="filterDate" class="border-2 border-blue-50 p-3 rounded-2xl outline-none focus:ring-4 focus:ring-blue-100 bg-gray-50 font-bold shadow-inner">
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button @click="printBulk" class="bg-[#142952] text-white px-8 py-4 rounded-2xl font-black flex items-center gap-2 shadow-xl hover:bg-blue-800 transition-all">
                            <i data-lucide="printer" class="w-5 h-5 text-yellow-400"></i> ุทุจุงุนุฉ ูุฌูุนุฉ
                        </button>
                        <button @click="downloadBulkPDF" class="bg-blue-600 text-white px-8 py-4 rounded-2xl font-black flex items-center gap-2 shadow-xl hover:bg-blue-700 transition-all">
                            <i data-lucide="file-down" class="w-5 h-5 text-white"></i> PDF ูุฌูุน
                        </button>
                        <button @click="downloadZIP" class="bg-green-600 text-white px-8 py-4 rounded-2xl font-black flex items-center gap-2 shadow-xl hover:bg-green-700 transition-all">
                            <i data-lucide="archive" class="w-5 h-5 text-white"></i> ZIP (ููุงุชูุฑ ูููุตูุฉ)
                        </button>
                    </div>
                </div>

                <div v-if="filteredByDateOrders.length === 0" class="py-32 text-center bg-white rounded-3xl border-4 border-dashed border-gray-100 shadow-none">
                    <i data-lucide="inbox" class="w-20 h-20 text-gray-100 mx-auto mb-6"></i>
                    <p class="text-gray-400 font-black text-xl">ูุง ุชูุฌุฏ ุณุฌูุงุช ูู ูุฐุง ุงูููู</p>
                </div>

                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div v-for="order in filteredByDateOrders" :key="order.id" class="bg-white p-8 rounded-3xl border-2 border-transparent hover:border-blue-500 shadow-sm transition-all cursor-pointer group relative overflow-hidden" @click="viewInvoice(order)">
                        <div class="flex justify-between items-start mb-6">
                            <span class="bg-blue-50 text-blue-700 px-4 py-1.5 rounded-full text-xs font-black tracking-widest uppercase">{{ order.orderId }}</span>
                            <span class="text-[10px] font-bold text-gray-300">{{ formatTime(order.timestamp) }}</span>
                        </div>
                        <h4 class="font-black text-[#142952] text-xl mb-1 truncate">{{ order.client.name }}</h4>
                        <p class="text-xs text-gray-400 line-clamp-1 mb-6">๐ {{ order.client.address }}</p>
                        <div class="flex justify-between items-center border-t border-dashed border-gray-100 pt-6">
                            <span class="font-black text-green-600 text-lg">{{ order.totalAmount }} SAR</span>
                            <span class="text-blue-600 font-black text-sm group-hover:underline">ูุนุงููุฉ ุงููุงุชูุฑุฉ</span>
                        </div>
                    </div>
                </div>
            </section>

            <section v-if="activeTab === 'catalog'" class="bg-white p-8 rounded-3xl border animate-in shadow-sm">
                <form @submit.prevent="saveCatalogItem" class="flex flex-wrap gap-6 mb-12 p-8 bg-gray-50 rounded-[2.5rem] items-end border border-white">
                    <div class="flex-1 min-w-[280px]">
                        <label class="block text-xs font-black text-gray-400 mb-2 uppercase">ุงุณู ุงูููุชุฌ ุงูุฌุฏูุฏ</label>
                        <input v-model="catalogForm.name" required class="w-full p-4 bg-white border-none rounded-2xl shadow-inner outline-none font-black text-[#142952]">
                    </div>
                    <div class="w-48">
                        <label class="block text-xs font-black text-gray-400 mb-2 uppercase">ุงูุณุนุฑ (SAR)</label>
                        <input v-model.number="catalogForm.price" required type="number" class="w-full p-4 bg-white border-none rounded-2xl shadow-inner outline-none font-black text-green-600">
                    </div>
                    <button type="submit" class="bg-[#142952] text-white px-10 py-4 rounded-2xl font-black shadow-lg transition-transform hover:scale-105">ุฅุถุงูุฉ ูููุชุฌุฑ</button>
                </form>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="item in catalog" :key="item.id" class="p-8 bg-white border-2 border-gray-50 rounded-2xl flex justify-between items-center hover:shadow-xl transition-all">
                        <div>
                            <h5 class="font-black text-[#142952] text-lg">{{ item.name }}</h5>
                            <p class="text-blue-600 font-black text-lg mt-1">{{ item.price }} SAR</p>
                        </div>
                        <button @click="deleteCatalogItem(item)" class="text-red-400 p-4 hover:bg-red-50 rounded-2xl transition-colors">
                            <i data-lucide="trash-2" class="w-6 h-6"></i>
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <div id="capture-area" dir="rtl">
            <div v-for="invoice in bulkList" :key="invoice.id" :id="'inv-' + invoice.orderId" class="invoice-a4">
                
                <div class="flex justify-between items-center mb-4 border-b-2 border-gray-100 pb-3">
                    <div class="w-20 h-20 bg-white flex items-center justify-center p-2 rounded-xl">
                        <img src="logo1.png" alt="Logo" class="w-full h-full object-contain" onerror="this.src='https://i.ibb.co/68vD84D/logo1.png'">
                    </div>
                    <div class="text-center">
                        <h1 class="text-3xl font-black text-[#142952]">ูุงุชูุฑุฉ</h1>
                    </div>
                    <div class="text-left font-black text-[11px] space-y-0.5">
                        <p>ุฑูู ุงููุงุชูุฑุฉ : #{{ invoice.orderId }}</p>
                        <p>ุชุงุฑูุฎ ุงูุทูุจ : {{ formatDateLong(invoice.timestamp) }}</p>
                        <p>ุงูุฑูู ุงูุถุฑูุจู : 310236446600003</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-4 text-[11px]">
                    <div class="inv-info-box space-y-1">
                        <span class="text-gray-400 font-bold">ูุตุฏุฑุฉ ุฅูู :</span>
                        <p class="font-black text-base text-gray-900">{{ invoice.client.name }}</p>
                        <p class="font-black text-[#142952] text-sm">{{ invoice.client.address }}</p>
                        <p class="font-bold text-gray-600">ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉุ {{ invoice.client.city }}</p>
                        <p dir="ltr" class="font-black text-sm">{{ invoice.client.phone }}</p>
                    </div>
                    <div class="inv-info-box text-left space-y-1 border-r-4 border-[#142952]">
                        <span class="text-gray-400 font-bold">ูุตุฏุฑุฉ ูู :</span>
                        <p class="font-black text-sm text-[#142952]">ุงููุชุฌุฑ ุงูุฅููุชุฑููู: ูููุฉ ุจูุชู</p>
                        <p class="font-bold">ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉุ ุงูุฑูุงุถ</p>
                        <p class="font-bold">ุงููุนููููุฉุ ุงูุฏูุฑุฉุ SA</p>
                        <p class="text-blue-600 font-bold">hwytbytk@gmail.com</p>
                        <p dir="ltr" class="font-black">+966 54 478 2301</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 border-y py-3 mb-4 text-[11px]">
                    <div class="space-y-2">
                        <span class="text-gray-400 font-bold">ุชูุงุตูู ุงูุฏูุน :</span>
                        <div class="flex justify-between font-bold">
                            <span>ุงููุจูุบ ุงูุฅุฌูุงูู :</span>
                            <span class="font-black text-[#142952]">SAR {{ invoice.totalAmount }}</span>
                        </div>
                        <div class="flex justify-between font-bold">
                            <span>ุทุฑููุฉ ุงูุณุฏุงุฏ :</span>
                            <span class="font-black">ูุฏู / ุฃูููุงูู</span>
                        </div>
                    </div>
                    <div class="text-left space-y-2">
                        <span class="text-gray-400 font-bold">ุชูุงุตูู ุงูุดุญู :</span>
                        <div class="flex flex-row-reverse gap-4 font-bold">
                            <div class="text-right space-y-1 text-gray-500">
                                <p>ุจูุงุณุทุฉ :</p>
                                <p>ุฃูุงู ุงูุดุญู ุงููุชููุนุฉ :</p>
                            </div>
                            <div class="text-left space-y-1 font-black text-[#142952]">
                                <p>ููุฏูุจูุง</p>
                                <p>(7 - 12 ููู ุนูู)</p>
                            </div>
                        </div>
                    </div>
                </div>

                <table class="inv-table">
                    <thead>
                        <tr>
                            <th class="rounded-tr-lg">ูุตู ุงูููุชุฌ ูุงูุฎูุงุฑุงุช ุงููุฎุตุตุฉ</th>
                            <th class="text-center w-16">ุงููููุฉ</th>
                            <th class="text-center w-24">ุงูุณุนุฑ</th>
                            <th class="text-left rounded-tl-lg w-24">ุงููุฌููุน</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="p in invoice.products" :key="p.id">
                            <td>
                                <div class="flex gap-3">
                                    <div class="w-12 h-12 bg-gray-50 border rounded-lg flex items-center justify-center p-1 shrink-0">
                                        <img :src="'products/' + p.name + '.webp'" 
                                             @error="handleImageFallback($event, p.name)"
                                             class="w-full h-full object-contain rounded-md">
                                    </div>
                                    <div class="space-y-1 flex-1">
                                        <p class="font-black text-sm text-gray-900">{{ p.name }} <span v-if="p.villaNo" class="text-[10px] text-gray-400 font-bold">(ูููุง {{ p.villaNo }})</span></p>
                                        <div class="text-[10px] bg-blue-50/50 p-2 rounded-lg border border-blue-100 space-y-0.5">
                                            <p class="font-black text-[#142952]">ุงูุฎูุงุฑุงุช: 
                                                <span class="font-normal text-black ml-2">โข ุงูููู: <span class="font-black">{{ p.color === 'silver' ? 'ูุถู' : 'ุฐูุจู' }}</span></span>
                                                <span v-if="p.nationalAddress" class="font-normal text-black ml-2">โข ุงูุนููุงู ุงููุทูู: <span class="font-black">{{ p.nationalAddress }}</span></span>
                                                <span v-if="p.customName" class="font-normal text-black ml-2">โข ุงูุงุณู: <span class="font-black text-blue-700 italic">{{ p.customName }}</span></span>
                                                <span v-if="p.notes" class="font-normal text-gray-500 ml-2 italic">โข ููุงุญุธุฉ: {{ p.notes }}</span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td class="text-center font-black text-sm bg-gray-50/30 align-middle">{{ p.count }}</td>
                            <td class="text-center font-bold text-xs align-middle">SAR {{ p.price }}</td>
                            <td class="text-left font-black text-sm text-[#142952] align-middle">SAR {{ p.price * p.count }}</td>
                        </tr>
                    </tbody>
                </table>

                <div class="mt-4 mr-auto w-72 space-y-1.5 border-t pt-3 text-xs">
                    <div class="flex justify-between font-bold text-gray-500">
                        <span>ูุฌููุน ุงูููุชุฌุงุช</span>
                        <span class="font-black text-black">SAR {{ (invoice.subTotal || invoice.totalAmount).toFixed(2) }}</span>
                    </div>
                    <div v-if="invoice.discountRate > 0" class="flex justify-between font-bold text-red-500">
                        <span>ุงูุฎุตู ({{ invoice.discountRate }}%)</span>
                        <span class="font-black text-red-600">- SAR {{ (((invoice.subTotal || invoice.totalAmount) * invoice.discountRate) / 100).toFixed(2) }}</span>
                    </div>
                    <div class="flex justify-between font-bold text-green-600">
                        <span>ุชูููุฉ ุงูุชูุตูู</span>
                        <span class="font-black underline decoration-2">ูุฌุงูุงู</span>
                    </div>
                    <div class="flex justify-between items-center bg-[#142952] text-white p-3 rounded-xl font-black text-lg shadow-md mt-2">
                        <span>ุฅุฌูุงูู ุงูุทูุจ</span>
                        <span>SAR {{ invoice.totalAmount }}</span>
                    </div>
                </div>

                <div class="absolute bottom-6 left-12 right-12 text-center border-t border-gray-200 pt-3 bg-white">
                    <p class="text-gray-400 font-black italic text-[11px] mb-2">ุดูุฑุงู ูุซูุชูู ุจูููุฉ ุจูุชู - ูุณุนุฏ ุจุฎุฏูุชูู ุฏุงุฆูุงู</p>
                    <div class="flex justify-center gap-8 text-[9px] font-bold text-gray-500">
                        <p>๐ +966 54 478 2301</p>
                        <p>๐ง hwytbytk@gmail.com</p>
                        <p>๐ ุงููุชุฌุฑ ุงูุฅููุชุฑููู: ูููุฉ ุจูุชู</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        const { createApp, ref, computed, onMounted, watchEffect, nextTick } = Vue;

        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw_xdhlwgkJebCbFW_GMfnX7XOylPEqyMPSB9bM_mqdvWv1fa0ClowoxARjVkMqGNm2/exec";

        createApp({
            setup() {
                const activeTab = ref('create');
                const orders = ref(JSON.parse(localStorage.getItem('hwayt_orders_v4') || '[]'));
                const loading = ref(false);
                const syncLoading = ref(false);
                const notification = ref(null);
                const searchQuery = ref('');
                const filterDate = ref(new Date().toISOString().split('T')[0]);
                const isSaving = ref(false);
                const bulkList = ref([]);
                const editingOrder = ref(null);

                // --- ุจุฑูุฌุฉ ุงูููุชุฌุงุช ุงูู 51 ุจุดูู ุซุงุจุช ุจูุงุกู ุนูู ุงูุฃุณุนุงุฑ ุงููุญุฏุฏุฉ ---
                const staticPrices = {
                    1: 149, 2: 199, 3: 225, 4: 225, 5: 249, 6: 229, 7: 215,
                    10: 225, 15: 166, 16: 235, 17: 199, 18: 218, 19: 299,
                    20: 299, 21: 344, 22: 344, 23: 344, 24: 344, 25: 288,
                    26: 259, 27: 219, 28: 288, 29: 219, 30: 259, 34: 219,
                    35: 289, 44: 249
                };
                const defaultDesigns = Array.from({length: 51}, (_, i) => ({
                    id: `design-${i+1}`,
                    name: `design-${i+1}`,
                    price: staticPrices[i+1] || 199 // 199 ุฑูุงู ุณุนุฑ ุงูุชุฑุงุถู ูููุงูุต
                }));
                const catalog = ref(defaultDesigns);
                const catalogForm = ref({ name: '', price: '' });

                const orderForm = ref({
                    managerCode: '',
                    discountRate: 0,
                    client: { name: '', city: '', address: '', phone: '' },
                    products: [{ id: Date.now(), productId: '', name: '', nationalAddress: '', villaNo: '', customName: '', notes: '', count: 1, color: 'silver', price: 0, basePrice: 0 }]
                });

                const showNotify = (msg, type = 'success') => {
                    notification.value = { msg, type };
                    setTimeout(() => notification.value = null, 4000);
                    setTimeout(() => lucide.createIcons(), 50);
                };

                const setTab = (t) => {
                    activeTab.value = t;
                    if (t !== 'create') cancelEdit();
                    setTimeout(() => lucide.createIcons(), 50);
                };

                const addProductRow = () => {
                    orderForm.value.products.push({ id: Date.now(), productId: '', name: '', nationalAddress: '', villaNo: '', customName: '', notes: '', count: 1, color: 'silver', price: 0, basePrice: 0 });
                };

                const removeProductRow = (idx) => orderForm.value.products.splice(idx, 1);

                // ุชุฒุงูู ุงูููุชุฌ ูุน ุงููุชููุฌ ูุญูุธ ุงูุณุนุฑ ุงูุฃุณุงุณู ููุชููู ูู ุฅุถุงูุฉ 19 ุฑูุงู ููุฐูุจู
                const syncProductData = (p) => {
                    const item = catalog.value.find(c => c.id === p.productId);
                    if (item) { 
                        p.name = item.name; 
                        p.basePrice = item.price; 
                        updatePrice(p);
                    }
                };

                const updatePrice = (p) => {
                    if (p.basePrice !== undefined) {
                        p.price = p.color === 'gold' ? p.basePrice + 19 : p.basePrice;
                    }
                };

                // ุงูุชุนุฏูู ุงูุฎุงุต ุจุงูุตูุฑ ููุนุงูุฌุฉ ุงูุตูุบ ุงููุฎุชููุฉ ุจุฐูุงุก
                const handleImageFallback = (e, productName) => {
                    const img = e.target;
                    if (!img.dataset.triedJpg) {
                        img.dataset.triedJpg = 'true';
                        img.src = 'products/' + productName + '.jpg';
                    } else if (!img.dataset.triedPng) {
                        img.dataset.triedPng = 'true';
                        img.src = 'products/' + productName + '.png';
                    } else {
                        img.onerror = null; // ูุฅููุงู ุงูุชูุฑุงุฑ ุงููุงููุงุฆู ูู ุญุงู ุนุฏู ูุฌูุฏ logo1.png ุฃูุถุงู
                        img.src = 'logo1.png';
                    }
                };

                const calculateSubTotal = () => orderForm.value.products.reduce((sum, p) => sum + (p.price * p.count), 0);
                const calculateDiscount = () => (calculateSubTotal() * (orderForm.value.discountRate || 0)) / 100;
                const calculateTotal = () => Math.round(calculateSubTotal() - calculateDiscount());

                const saveOrder = async () => {
                    isSaving.value = true;
                    // ุงุณุชุฎุฑุงุฌ ุญุฑูู ุงููุณุคูู ููุถุนููุง ูู ุจุฏุงูุฉ ุฑูู ุงูุทูุจ
                    const mCode = (orderForm.value.managerCode || 'XX').toUpperCase().substring(0,2);
                    const orderId = editingOrder.value ? editingOrder.value.orderId : (`${mCode}-` + Math.random().toString(36).substr(2, 6).toUpperCase());
                    
                    const payload = {
                        orderId,
                        managerCode: orderForm.value.managerCode,
                        discountRate: orderForm.value.discountRate || 0,
                        subTotal: calculateSubTotal(),
                        client: JSON.parse(JSON.stringify(orderForm.value.client)),
                        products: JSON.parse(JSON.stringify(orderForm.value.products)),
                        totalAmount: calculateTotal(),
                        timestamp: editingOrder.value ? editingOrder.value.timestamp : new Date().toISOString(),
                        action: editingOrder.value ? 'update' : 'create',
                        target: 'orders'
                    };

                    try {
                        if (editingOrder.value) {
                            const idx = orders.value.findIndex(o => o.orderId === editingOrder.value.orderId);
                            orders.value[idx] = payload;
                        } else {
                            orders.value.unshift(payload);
                        }
                        localStorage.setItem('hwayt_orders_v4', JSON.stringify(orders.value));

                        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });

                        showNotify(`ุชู ุญูุธ ุงูุทูุจ: ${orderId}`);
                        cancelEdit();
                        setTab('archive');
                    } catch (e) {
                        showNotify("ุญูุธ ูุญูู ููุท (ูุดู ุงูุณุญุงุจ)", "error");
                    } finally { isSaving.value = false; }
                };

                const editOrder = (order) => {
                    editingOrder.value = order;
                    orderForm.value = {
                        managerCode: order.managerCode || order.orderId.split('-')[0] || '',
                        discountRate: order.discountRate || 0,
                        client: JSON.parse(JSON.stringify(order.client)),
                        products: JSON.parse(JSON.stringify(order.products))
                    };
                    // ุชููุฆุฉ ุงูุฃุณุนุงุฑ ุงูุฃุณุงุณูุฉ ููุทูุจุงุช ุงููุฏููุฉ ุนูุฏ ุชุนุฏูููุง
                    orderForm.value.products.forEach(p => {
                        if(!p.basePrice) p.basePrice = p.color === 'gold' ? p.price - 19 : p.price;
                    });
                    setTab('create');
                };

                const cancelEdit = () => {
                    editingOrder.value = null;
                    orderForm.value = {
                        managerCode: '',
                        discountRate: 0,
                        client: { name: '', city: '', address: '', phone: '' },
                        products: [{ id: Date.now(), productId: '', name: '', nationalAddress: '', villaNo: '', customName: '', notes: '', count: 1, color: 'silver', price: 0, basePrice: 0 }]
                    };
                };

                const deleteOrder = (order) => {
                    if (confirm(`ุญุฐู ุงูุทูุจ ${order.orderId} ููุงุฆูุงูุ`)) {
                        orders.value = orders.value.filter(o => o.orderId !== order.orderId);
                        localStorage.setItem('hwayt_orders_v4', JSON.stringify(orders.value));
                        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', orderId: order.orderId, target: 'orders' }) });
                        showNotify("ุชู ุงูุญุฐู ุจูุฌุงุญ");
                    }
                };

                const syncFromSheet = async () => {
                    syncLoading.value = true;
                    try {
                        const res = await fetch(GOOGLE_SCRIPT_URL);
                        const result = await res.json();
                        
                        const grouped = {};
                        result.orders.forEach(row => {
                            const oid = row['ุฑูู ุงูุทูุจ'];
                            if (!oid) return;
                            if (!grouped[oid]) {
                                grouped[oid] = {
                                    orderId: oid,
                                    managerCode: oid.split('-')[0] || 'XX',
                                    client: { name: row['ุงูุนููู'], city: row['ุงููุฏููุฉ'], phone: row['ุงูุฌูุงู'], address: row['ุงูุนููุงู ุจุงูุชูุตูู'] },
                                    products: [], totalAmount: 0, subTotal: 0, discountRate: 0,
                                    timestamp: row['ุงูุชุงุฑูุฎ'] || new Date().toISOString()
                                };
                            }
                            const p = {
                                name: row['ุงูููุชุฌ'], color: row['ุงูููู'], count: parseInt(row['ุงูุนุฏุฏ'] || 1), 
                                price: parseFloat(row['ุงูุณุนุฑ ุงููุฑุฏู'] || 0), nationalAddress: row['ุงูุนููุงู ุงููุทูู'],
                                villaNo: row['ุฑูู ุงููููุง'], customName: row['ุงูุงุณู ุงููุฎุตุต'], notes: row['ููุงุญุธุงุช']
                            };
                            p.basePrice = p.color === 'gold' ? p.price - 19 : p.price;
                            grouped[oid].products.push(p);
                            grouped[oid].totalAmount += (p.price * p.count);
                            grouped[oid].subTotal = grouped[oid].totalAmount; // ุชุนููู ูุจุฏุฆู
                        });
                        orders.value = Object.values(grouped);
                        localStorage.setItem('hwayt_orders_v4', JSON.stringify(orders.value));
                        showNotify("ุชูุช ุงููุฒุงููุฉ ุงููุงููุฉ ูู ุงูุณุญุงุจ");
                    } catch (e) {
                        showNotify("ุฎุทุฃ ูู ุงููุฒุงููุฉ ุงูุณุญุงุจูุฉ", "error");
                    } finally { syncLoading.value = false; }
                };

                const saveCatalogItem = async () => {
                    const newItem = { id: Date.now().toString(), ...catalogForm.value, action: 'create', target: 'catalog' };
                    catalog.value.push(newItem);
                    showNotify("ุชูุช ุฅุถุงูุฉ ุงูููุชุฌ ุจูุฌุงุญ (ูุญููุงู)");
                    catalogForm.value = { name: '', price: '' };
                };

                const deleteCatalogItem = (item) => {
                    if (confirm("ุญุฐู ุงูููุชุฌ ูู ุงููุชุงููุฌุ")) {
                        catalog.value = catalog.value.filter(i => i.id !== item.id);
                        showNotify("ุชู ุญุฐู ุงูููุชุฌ");
                    }
                };

                const generatePDFBlob = async (orderId) => {
                    const { jsPDF } = window.jspdf;
                    const element = document.getElementById('inv-' + orderId);
                    const canvas = await html2canvas(element, { 
                        scale: 2, 
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    });
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    pdf.addImage(imgData, 'PNG', 0, 0, 210, 297);
                    return pdf;
                };

                const viewInvoice = (order) => {
                    bulkList.value = [order];
                    nextTick(() => setTimeout(() => window.print(), 800));
                };

                const downloadBulkPDF = async () => {
                    if (filteredByDateOrders.value.length === 0) return showNotify("ูุง ููุฌุฏ ููุงุชูุฑ", "error");
                    const { jsPDF } = window.jspdf;
                    const finalPDF = new jsPDF('p', 'mm', 'a4');
                    loading.value = true;
                    showNotify("ุฌุงุฑู ุจูุงุก ุงูููู ุงููุฌูุน (ูุฑุฌู ุงูุงูุชุธุงุฑ)...");
                    
                    for (let i = 0; i < filteredByDateOrders.value.length; i++) {
                        const order = filteredByDateOrders.value[i];
                        bulkList.value = [order];
                        await nextTick();
                        await new Promise(r => setTimeout(r, 300));
                        const canvas = await html2canvas(document.getElementById('inv-' + order.orderId), { scale: 1.5 });
                        const img = canvas.toDataURL('image/png');
                        if (i > 0) finalPDF.addPage();
                        finalPDF.addImage(img, 'PNG', 0, 0, 210, 297);
                    }
                    finalPDF.save(`ููุงุชูุฑ_ูููุฉ_ุจูุชู_${filterDate.value}.pdf`);
                    loading.value = false;
                };

                const downloadZIP = async () => {
                    if (filteredByDateOrders.value.length === 0) return showNotify("ูุง ููุฌุฏ ููุงุชูุฑ", "error");
                    const zip = new JSZip();
                    loading.value = true;
                    showNotify("ุฌุงุฑู ุจูุงุก ุงููููุงุช ุงููููุตูุฉ...");

                    for (const order of filteredByDateOrders.value) {
                        bulkList.value = [order];
                        await nextTick();
                        await new Promise(r => setTimeout(r, 300));
                        const pdf = await generatePDFBlob(order.orderId);
                        zip.file(`${order.orderId}.pdf`, pdf.output('blob'));
                    }
                    
                    zip.generateAsync({type:"blob"}).then(content => {
                        const link = document.createElement('a');
                        link.href = URL.createObjectURL(content);
                        link.download = `ููุงุชูุฑ_ูููุฉ_ุจูุชู_${filterDate.value}.zip`;
                        link.click();
                        loading.value = false;
                    });
                };

                const printBulk = () => {
                    if (filteredByDateOrders.value.length === 0) return showNotify("ูุง ููุฌุฏ ููุงุชูุฑ ุงูููู", "error");
                    bulkList.value = filteredByDateOrders.value;
                    nextTick(() => setTimeout(() => window.print(), 800));
                };

                const filteredOrders = computed(() => {
                    const q = searchQuery.value.toUpperCase();
                    return orders.value.filter(o => o.orderId.includes(q) || (o.client?.name || "").includes(searchQuery.value))
                        .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                });

                const filteredByDateOrders = computed(() => orders.value.filter(o => (o.timestamp || "").split('T')[0] === filterDate.value));

                const formatDate = (ts) => ts ? new Date(ts).toLocaleDateString('ar-SA') : '-';
                const formatDateLong = (ts) => ts ? new Date(ts).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : '-';
                const formatTime = (ts) => ts ? new Date(ts).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '-';

                onMounted(() => {
                    setTimeout(() => lucide.createIcons(), 500);
                    syncFromSheet();
                });
                watchEffect(() => setTimeout(() => lucide.createIcons(), 100));

                return {
                    activeTab, orders, catalog, notification, searchQuery, filterDate, isSaving, syncLoading, loading,
                    orderForm, catalogForm, bulkList, editingOrder,
                    addProductRow, removeProductRow, syncProductData, updatePrice, handleImageFallback, saveOrder, deleteOrder, editOrder, cancelEdit,
                    saveCatalogItem, deleteCatalogItem, viewInvoice, printBulk, downloadBulkPDF, downloadZIP, syncFromSheet, calculateTotal, calculateSubTotal,
                    filteredOrders, filteredByDateOrders, formatDate, formatDateLong, formatTime, setTab
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
