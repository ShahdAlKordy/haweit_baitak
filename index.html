<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هوية بيتك - إدارة متكاملة</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #f8fafc; }
        .sidebar { background-color: #142952; }
        .active-tab { background-color: rgba(255, 255, 255, 0.1); border-left: 4px solid white; }
        
        /* تنسيقات الطباعة */
        .print-only { display: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; width: 100% !important; margin: 0 !important; padding: 0 !important; }
            .invoice-page { page-break-after: always; border: none !important; box-shadow: none !important; padding: 10mm !important; background: white !important; }
            body { background: white !important; }
            main { margin: 0 !important; padding: 0 !important; }
        }
        
        .animate-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal-bg { background-color: rgba(0, 0, 0, 0.5); }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen flex">
        <!-- Sidebar -->
        <aside class="sidebar w-64 text-white fixed h-full flex flex-col no-print z-20">
            <div class="p-8 border-b border-white/5 flex flex-col items-center text-center">
                <div class="w-20 h-20 bg-white rounded-2xl mb-4 flex items-center justify-center p-2 shadow-xl">
                    <img src="https://i.ibb.co/68vD84D/logo1.png" alt="Logo" class="w-full h-full object-contain">
                </div>
                <h1 class="text-xl font-black">هوية بيتك</h1>
                <p class="text-blue-300 text-[10px] mt-1 tracking-widest uppercase">نظام إدارة الطلبات</p>
            </div>
            
            <nav class="flex-1 py-10 px-4 space-y-2">
                <button @click="setTab('create')" :class="{'active-tab': activeTab === 'create'}" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl transition-all font-bold hover:bg-white/5">
                    <i data-lucide="plus-circle" class="w-5 h-5"></i> تسجيل طلب
                </button>
                <button @click="setTab('archive')" :class="{'active-tab': activeTab === 'archive'}" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl transition-all font-bold hover:bg-white/5">
                    <i data-lucide="database" class="w-5 h-5"></i> أرشيف الطلبات
                </button>
                <button @click="setTab('invoices')" :class="{'active-tab': activeTab === 'invoices'}" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl transition-all font-bold hover:bg-white/5">
                    <i data-lucide="file-text" class="w-5 h-5"></i> فواتير اليوم
                </button>
                <button @click="setTab('catalog')" :class="{'active-tab': activeTab === 'catalog'}" class="w-full flex items-center gap-4 px-6 py-4 rounded-xl transition-all font-bold hover:bg-white/5">
                    <i data-lucide="settings" class="w-5 h-5"></i> إدارة المنتجات
                </button>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 mr-64 p-8 no-print">
            <!-- Loader -->
            <div v-if="loading" class="fixed inset-0 bg-white/80 z-50 flex flex-col items-center justify-center">
                <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-[#142952]"></div>
                <p class="mt-4 font-bold text-[#142952]">جاري المزامنة مع السحاب...</p>
            </div>

            <!-- Notifications -->
            <div v-if="notification" class="fixed top-8 left-8 z-50 p-4 rounded-2xl shadow-2xl bg-white border-l-8 flex items-center gap-3 animate-in" :class="notification.type === 'error' ? 'border-red-500 text-red-600' : 'border-green-500 text-green-600'">
                <i v-if="notification.type === 'success'" data-lucide="check-circle"></i>
                <i v-else data-lucide="alert-circle"></i>
                <span class="font-bold">{{ notification.msg }}</span>
            </div>

            <header class="mb-10 flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-black text-[#142952]">
                        <span v-if="activeTab === 'create'">{{ editingOrder ? 'تعديل بيانات الطلب' : 'تسجيل طلب جديد' }}</span>
                        <span v-if="activeTab === 'archive'">الأرشيف والمزامنة</span>
                        <span v-if="activeTab === 'invoices'">إصدار الفواتير</span>
                        <span v-if="activeTab === 'catalog'">كتالوج المنتجات</span>
                    </h2>
                    <p class="text-gray-500">مرحباً شهد، البيانات محدثة لحظياً</p>
                </div>
            </header>

            <!-- 1. Create/Edit Order -->
            <section v-if="activeTab === 'create'" class="animate-in bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <form @submit.prevent="saveOrder" class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 bg-gray-50 p-6 rounded-2xl">
                        <div class="col-span-full font-bold text-[#142952] flex items-center gap-2 mb-2">
                            <i data-lucide="user" class="w-4 h-4"></i> بيانات العميل الأساسية
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">اسم العميل</label>
                            <input v-model="orderForm.client.name" required class="w-full p-2.5 border rounded-xl shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">المدينة</label>
                            <input v-model="orderForm.client.city" required class="w-full p-2.5 border rounded-xl shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">رقم الجوال</label>
                            <input v-model="orderForm.client.phone" required class="w-full p-2.5 border rounded-xl shadow-sm outline-none focus:ring-2 focus:ring-blue-500" placeholder="05xxxxxxxx">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 mb-1">العنوان بالتفصيل</label>
                            <input v-model="orderForm.client.address" required class="w-full p-2.5 border rounded-xl shadow-sm outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="flex justify-between items-center border-b-2 border-gray-100 pb-2">
                            <h3 class="font-bold text-[#142952] flex items-center gap-2"><i data-lucide="package" class="w-5 h-5"></i> قائمة المنتجات المطلوبة</h3>
                            <button type="button" @click="addProductRow" class="text-blue-700 font-bold hover:underline">+ إضافة منتج</button>
                        </div>
                        <div v-for="(p, index) in orderForm.products" :key="p.id" class="p-6 border-2 border-gray-50 rounded-2xl bg-white relative hover:border-blue-100 transition-all shadow-sm">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-5">
                                <div>
                                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">المنتج</label>
                                    <select v-model="p.productId" @change="syncProductData(p)" required class="w-full p-2.5 border rounded-xl text-sm bg-gray-50 font-bold">
                                        <option value="">اختر المنتج...</option>
                                        <option v-for="item in catalog" :value="item.id">{{ item.name }} ({{ item.price }} SAR)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">اللون</label>
                                    <select v-model="p.color" class="w-full p-2.5 border rounded-xl text-sm">
                                        <option value="silver">سيلفر (فضي)</option>
                                        <option value="gold">جولد (ذهبي)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">الكمية</label>
                                    <input v-model.number="p.count" type="number" min="1" class="w-full p-2.5 border rounded-xl text-sm">
                                </div>
                                <div>
                                    <label class="block text-[11px] font-bold text-[#142952] uppercase mb-1 font-black">العنوان الوطني</label>
                                    <input v-model="p.nationalAddress" class="w-full p-2.5 border border-blue-200 rounded-xl text-sm bg-blue-50/30" placeholder="الرمز الوطني">
                                </div>
                                <div>
                                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">رقم الفيلا/الباب</label>
                                    <input v-model="p.villaNo" class="w-full p-2.5 border rounded-xl text-sm">
                                </div>
                                <div>
                                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">الاسم المخصص</label>
                                    <input v-model="p.customName" class="w-full p-2.5 border rounded-xl text-sm" placeholder="الاسم المكتوب">
                                </div>
                                <div class="lg:col-span-2">
                                    <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">ملاحظات إضافية</label>
                                    <input v-model="p.notes" class="w-full p-2.5 border rounded-xl text-sm" placeholder="أي تفاصيل أخرى...">
                                </div>
                            </div>
                            <button v-if="orderForm.products.length > 1" @click="removeProductRow(index)" type="button" class="absolute -top-3 -left-3 bg-red-500 text-white p-2 rounded-full shadow-lg">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div class="flex justify-between items-center border-t border-gray-100 pt-8">
                        <div class="text-[#142952]">
                            <p class="text-sm font-bold">إجمالي الطلب:</p>
                            <p class="text-3xl font-black text-green-600">{{ calculateTotal() }} SAR</p>
                        </div>
                        <div class="flex gap-4">
                            <button v-if="editingOrder" type="button" @click="cancelEdit" class="px-8 py-4 rounded-xl font-bold bg-gray-200">إلغاء</button>
                            <button type="submit" :disabled="isSaving" class="bg-[#142952] text-white px-12 py-5 rounded-2xl font-black shadow-2xl hover:scale-105 active:scale-95 transition-all disabled:opacity-50">
                                {{ isSaving ? 'جاري الحفظ...' : (editingOrder ? 'تحديث الطلب' : 'تأكيد وحفظ الطلب') }}
                            </button>
                        </div>
                    </div>
                </form>
            </section>

            <!-- 2. Archive -->
            <section v-if="activeTab === 'archive'" class="animate-in bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-6 border-b flex justify-between items-center bg-gray-50/50">
                    <div class="relative w-80">
                        <i data-lucide="search" class="absolute right-3 top-2.5 text-gray-400 w-4 h-4"></i>
                        <input v-model="searchQuery" class="w-full pr-10 pl-4 py-2.5 bg-white border rounded-full text-sm outline-none" placeholder="ابحث بالاسم أو رقم الطلب...">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-right text-sm">
                        <thead class="bg-[#142952] text-white">
                            <tr>
                                <th class="p-4">رقم الطلب</th>
                                <th class="p-4">التاريخ</th>
                                <th class="p-4">العميل</th>
                                <th class="p-4">العنوان بالتفصيل</th>
                                <th class="p-4">المبلغ</th>
                                <th class="p-4">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="order in filteredOrders" :key="order.id" class="border-b hover:bg-gray-50">
                                <td class="p-4 font-mono font-bold text-blue-700">{{ order.orderId }}</td>
                                <td class="p-4 text-xs text-gray-500">{{ formatDate(order.timestamp) }}</td>
                                <td class="p-4 font-bold">{{ order.client.name }}</td>
                                <td class="p-4 max-w-xs truncate">{{ order.client.address }}</td>
                                <td class="p-4 font-black text-green-600">{{ order.totalAmount }} SAR</td>
                                <td class="p-4">
                                    <div class="flex gap-2">
                                        <button @click="viewInvoice(order)" class="p-2 bg-blue-50 text-blue-600 rounded-lg"><i data-lucide="printer" class="w-4 h-4"></i></button>
                                        <button @click="editOrder(order)" class="p-2 bg-yellow-50 text-yellow-600 rounded-lg"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                        <button @click="deleteOrder(order)" class="p-2 bg-red-50 text-red-500 rounded-lg"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- 3. Invoices -->
            <section v-if="activeTab === 'invoices'" class="animate-in space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <label class="font-bold text-[#142952]">تاريخ اليوم:</label>
                        <input type="date" v-model="filterDate" class="border p-2 rounded-xl outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <button @click="printBulk" class="bg-[#142952] text-white px-6 py-2 rounded-xl font-bold flex items-center gap-2 shadow-lg">
                        <i data-lucide="printer" class="w-4 h-4"></i> طباعة كافة فواتير هذا اليوم
                    </button>
                </div>

                <div v-if="filteredByDateOrders.length === 0" class="text-center py-20 bg-white rounded-2xl border-2 border-dashed border-gray-100">
                    <p class="text-gray-400 font-bold">لا توجد طلبات في هذا التاريخ</p>
                </div>

                <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div v-for="order in filteredByDateOrders" :key="order.id" class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 relative group cursor-pointer" @click="viewInvoice(order)">
                        <div class="flex justify-between items-start mb-4">
                            <span class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-[10px] font-black uppercase">{{ order.orderId }}</span>
                            <span class="text-xs text-gray-400">{{ formatTime(order.timestamp) }}</span>
                        </div>
                        <h4 class="font-bold text-lg mb-1 text-[#142952]">{{ order.client.name }}</h4>
                        <p class="text-xs text-gray-500 mb-4 line-clamp-1">{{ order.client.address }}</p>
                        <div class="flex justify-between items-center border-t pt-4">
                            <span class="font-black text-green-600">{{ order.totalAmount }} SAR</span>
                            <span class="text-blue-600 font-bold text-xs flex items-center gap-1">معاينة الفاتورة <i data-lucide="chevron-left" class="w-3 h-3"></i></span>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. Catalog -->
            <section v-if="activeTab === 'catalog'" class="animate-in bg-white p-8 rounded-2xl shadow-sm border border-gray-100">
                <form @submit.prevent="saveCatalogItem" class="flex flex-wrap gap-4 mb-10 items-end bg-gray-50 p-6 rounded-2xl">
                    <div class="flex-1 min-w-[200px]">
                        <label class="block text-xs font-bold text-gray-400 mb-1">اسم المنتج</label>
                        <input v-model="catalogForm.name" required class="w-full p-2.5 border rounded-xl shadow-sm" placeholder="مثال: لوحة عنوان مودرن">
                    </div>
                    <div class="w-32">
                        <label class="block text-xs font-bold text-gray-400 mb-1">السعر (SAR)</label>
                        <input v-model.number="catalogForm.price" required type="number" class="w-full p-2.5 border rounded-xl shadow-sm">
                    </div>
                    <button type="submit" class="bg-[#142952] text-white px-8 py-2.5 rounded-xl font-bold h-[46px]">إضافة للمتجر</button>
                </form>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div v-for="item in catalog" :key="item.id" class="p-5 border rounded-2xl flex justify-between items-center hover:shadow-md transition-all bg-white">
                        <div>
                            <h5 class="font-bold text-[#142952]">{{ item.name }}</h5>
                            <p class="text-blue-600 font-bold text-sm">{{ item.price }} SAR</p>
                        </div>
                        <button @click="deleteCatalogItem(item.id)" class="text-red-400 p-2 hover:bg-red-50 rounded-lg">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </section>
        </main>

        <!-- منطقة الطباعة (مخفية دائماً في الواجهة) -->
        <div id="print-area" class="print-only" dir="rtl">
            <div v-for="invoice in bulkList" :key="invoice.id" class="invoice-page bg-white p-16 max-w-5xl mx-auto mb-10 border shadow-sm">
                <div class="flex justify-between items-start mb-12 pb-10 border-b-4 border-[#142952]">
                    <div>
                        <h1 class="text-6xl font-black text-[#142952] mb-4">فاتورة</h1>
                        <p class="text-gray-600 text-lg">رقم الفاتورة: <span class="font-black text-black">#{{ invoice.orderId }}</span></p>
                        <p class="text-gray-600 text-lg">التاريخ: {{ formatDate(invoice.timestamp) }}</p>
                        <p class="text-gray-600 text-lg">الرقم الضريبي: 310236446600003</p>
                    </div>
                    <div class="text-left flex flex-col items-end">
                        <div class="w-32 h-32 bg-[#142952] rounded-3xl mb-4 flex items-center justify-center p-4 shadow-lg">
                            <img src="https://i.ibb.co/68vD84D/logo1.png" alt="Logo" class="w-full h-full object-contain filter invert">
                        </div>
                        <p class="font-black text-2xl text-[#142952]">هوية بيتك</p>
                        <p class="text-gray-500 font-bold">للوحات العنوان الفاخرة</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-12 mb-12">
                    <div class="bg-gray-50 p-8 rounded-3xl">
                        <h3 class="font-black text-[#142952] border-b-2 mb-4 pb-1 text-xl">بيانات العميل:</h3>
                        <p class="font-black text-2xl mb-2">{{ invoice.client.name }}</p>
                        <p class="text-lg text-gray-700">{{ invoice.client.city }}</p>
                        <p class="text-lg font-black text-blue-900 mt-2">{{ invoice.client.address }}</p>
                        <p class="text-xl mt-4 font-bold" dir="ltr">{{ invoice.client.phone }}</p>
                    </div>
                    <div class="bg-gray-50 p-8 rounded-3xl">
                        <h3 class="font-black text-[#142952] border-b-2 mb-4 pb-1 text-xl">تفاصيل المتجر:</h3>
                        <p class="font-black text-xl">متجر هوية بيتك</p>
                        <p class="text-lg">المملكة العربية السعودية، الرياض</p>
                        <p class="text-lg mt-2 font-bold">hwytbytk@gmail.com</p>
                        <p class="text-lg" dir="ltr">+966 54 478 2301</p>
                    </div>
                </div>

                <table class="w-full mb-12 border-collapse rounded-2xl overflow-hidden border">
                    <thead class="bg-[#142952] text-white">
                        <tr>
                            <th class="p-5 text-right text-lg">المنتج والتفاصيل المخصصة</th>
                            <th class="p-5 text-center text-lg">العدد</th>
                            <th class="p-5 text-left text-lg">المجموع</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="p in invoice.products" class="border-b bg-white">
                            <td class="p-6">
                                <div class="font-black text-xl text-gray-900 mb-1">{{ p.name }}</div>
                                <div class="flex flex-wrap gap-4 text-sm text-gray-500">
                                    <span class="bg-gray-100 px-3 py-1 rounded-full font-bold">اللون: {{ p.color === 'silver' ? 'سيلفر' : 'جولد' }}</span>
                                    <span v-if="p.nationalAddress" class="bg-blue-50 text-blue-700 px-3 py-1 rounded-full font-black">العنوان الوطني: {{ p.nationalAddress }}</span>
                                    <span v-if="p.villaNo" class="bg-gray-100 px-3 py-1 rounded-full font-bold">فيلا: {{ p.villaNo }}</span>
                                </div>
                                <div v-if="p.customName" class="mt-3 text-[#142952] font-black italic border-r-4 border-blue-500 pr-3">
                                    الاسم على اللوحة: {{ p.customName }}
                                </div>
                            </td>
                            <td class="p-6 text-center text-2xl font-black">{{ p.count }}</td>
                            <td class="p-6 text-left font-black text-2xl text-green-700">{{ p.price * p.count }} SAR</td>
                        </tr>
                    </tbody>
                </table>

                <div class="flex justify-end">
                    <div class="w-80 bg-[#142952] text-white p-8 rounded-3xl shadow-2xl space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="font-bold opacity-70">المجموع الفرعي</span>
                            <span class="font-black text-xl">{{ invoice.totalAmount }} SAR</span>
                        </div>
                        <div class="flex justify-between items-center border-t border-white/10 pt-4">
                            <span class="font-black text-lg">الإجمالي النهائي</span>
                            <span class="text-4xl font-black">{{ invoice.totalAmount }} SAR</span>
                        </div>
                    </div>
                </div>

                <div class="mt-32 text-center text-gray-300 font-bold italic">
                    شكراً لتعاملكم مع هوية بيتك - نسعد بخدمتكم دائماً
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, setDoc, getDocs, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const { createApp, ref, computed, onMounted, watchEffect, nextTick } = Vue;

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hwayt-bytk-v1';
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxa6rmwo_4kCorqvihWtNcgy6hlZKLMcSJnNr_m8kp0h-vLATsiUVcDyoUXuuQuJBTn/exec";

        createApp({
            setup() {
                const activeTab = ref('create');
                const user = ref(null);
                const orders = ref([]);
                const catalog = ref([]);
                const loading = ref(true);
                const notification = ref(null);
                const searchQuery = ref('');
                const filterDate = ref(new Date().toISOString().split('T')[0]);
                const isSaving = ref(false);
                const bulkList = ref([]);
                const editingOrder = ref(null);

                const orderForm = ref({
                    client: { name: '', city: '', address: '', phone: '' },
                    products: [{ id: Date.now(), productId: '', name: '', nationalAddress: '', villaNo: '', customName: '', notes: '', count: 1, color: 'silver', price: 0 }]
                });

                const catalogForm = ref({ name: '', price: '' });

                // البروتوكول الصارم للاتصال (Auth First)
                onMounted(async () => {
                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (e) { console.error("Auth error:", e); }
                    };
                    await initAuth();

                    onAuthStateChanged(auth, (u) => {
                        user.value = u;
                        if (u) {
                            // Listeners تفتح فقط بعد الـ Auth
                            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), (snap) => {
                                orders.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                                loading.value = false;
                            }, (err) => console.error("Firestore Orders error:", err));

                            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'catalog'), (snap) => {
                                catalog.value = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                            }, (err) => console.error("Firestore Catalog error:", err));
                        }
                    });
                });

                const showNotify = (msg, type = 'success') => {
                    notification.value = { msg, type };
                    setTimeout(() => notification.value = null, 4000);
                    setTimeout(() => lucide.createIcons(), 100);
                };

                const setTab = (t) => {
                    activeTab.value = t;
                    if (t !== 'create') cancelEdit();
                    setTimeout(() => lucide.createIcons(), 50);
                };

                const addProductRow = () => {
                    orderForm.value.products.push({ id: Date.now(), productId: '', name: '', nationalAddress: '', villaNo: '', customName: '', notes: '', count: 1, color: 'silver', price: 0 });
                };

                const removeProductRow = (idx) => { orderForm.value.products.splice(idx, 1); };

                const syncProductData = (p) => {
                    const item = catalog.value.find(c => c.id === p.productId);
                    if (item) { p.name = item.name; p.price = item.price; }
                };

                const calculateTotal = () => orderForm.value.products.reduce((sum, p) => sum + (p.price * p.count), 0);

                const saveOrder = async () => {
                    if (!user.value) return;
                    isSaving.value = true;
                    
                    const orderId = editingOrder.value ? editingOrder.value.orderId : ('ORD-' + Math.random().toString(36).substr(2, 8).toUpperCase());
                    const payload = {
                        orderId,
                        client: { ...orderForm.value.client },
                        products: [...orderForm.value.products],
                        totalAmount: calculateTotal(),
                        timestamp: editingOrder.value ? editingOrder.value.timestamp : new Date().toISOString(),
                        action: editingOrder.value ? 'update' : 'create'
                    };

                    try {
                        // المزامنة مع Firestore
                        if (editingOrder.value) {
                            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', editingOrder.value.id), payload);
                        } else {
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), payload);
                        }
                        
                        // المزامنة مع Google Sheets (العنوان بعد التاريخ يتم برمجياً في الـ Apps Script)
                        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });

                        showNotify(`تم الحفظ بنجاح: ${orderId}`);
                        cancelEdit();
                        setTab('archive');
                    } catch (e) { showNotify("خطأ في المزامنة السحابية", "error"); } finally { isSaving.value = false; }
                };

                const editOrder = (order) => {
                    editingOrder.value = order;
                    orderForm.value = {
                        client: { ...order.client },
                        products: JSON.parse(JSON.stringify(order.products))
                    };
                    activeTab.value = 'create';
                    setTimeout(() => lucide.createIcons(), 50);
                };

                const cancelEdit = () => {
                    editingOrder.value = null;
                    orderForm.value = {
                        client: { name: '', city: '', address: '', phone: '' },
                        products: [{ id: Date.now(), productId: '', name: '', nationalAddress: '', villaNo: '', customName: '', notes: '', count: 1, color: 'silver', price: 0 }]
                    };
                };

                const deleteOrder = async (order) => {
                    if (confirm(`حذف الطلب ${order.orderId} نهائياً؟`)) {
                        await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', order.id));
                        fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', orderId: order.orderId }) });
                        showNotify("تم الحذف من كافة السجلات");
                    }
                };

                const saveCatalogItem = async () => {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'catalog'), catalogForm.value);
                    catalogForm.value = { name: '', price: '' };
                };

                const deleteCatalogItem = async (id) => { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'catalog', id)); };

                // تحسين الطباعة والمعاينة
                const viewInvoice = (order) => {
                    bulkList.value = [order];
                    nextTick(() => {
                        setTimeout(() => window.print(), 500);
                    });
                };

                const printBulk = () => {
                    if (filteredByDateOrders.value.length === 0) {
                        showNotify("لا توجد فواتير اليوم المختار", "error");
                        return;
                    }
                    bulkList.value = [...filteredByDateOrders.value];
                    nextTick(() => {
                        setTimeout(() => window.print(), 500);
                    });
                };

                const filteredOrders = computed(() => {
                    const q = searchQuery.value.toUpperCase();
                    return orders.value.filter(o => o.orderId.includes(q) || o.client.name.includes(searchQuery.value))
                        .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                });

                const filteredByDateOrders = computed(() => {
                    return orders.value.filter(o => o.timestamp.split('T')[0] === filterDate.value);
                });

                const formatDate = (ts) => new Date(ts).toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
                const formatTime = (ts) => new Date(ts).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });

                watchEffect(() => { setTimeout(() => lucide.createIcons(), 100); });

                return {
                    activeTab, orders, catalog, loading, notification, searchQuery, filterDate, isSaving,
                    orderForm, catalogForm, bulkList, editingOrder, setTab,
                    addProductRow, removeProductRow, syncProductData, saveOrder, deleteOrder, editOrder, cancelEdit,
                    saveCatalogItem, deleteCatalogItem, viewInvoice, printBulk, calculateTotal,
                    filteredOrders, filteredByDateOrders, formatDate, formatTime
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
